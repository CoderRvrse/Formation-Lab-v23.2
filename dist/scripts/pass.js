var Z=Object.defineProperty;var l=(t,e)=>Z(t,"name",{value:e,configurable:!0});import{FLAB as o,AIM as v,headSpec as K,PASS as b}from"./state.js";import{HEAD_OVERLAP as tt}from"./assets.arrows.js";import{centerInField as G,fieldSize as et,clipSegmentToRect as ot,insetFromA as T,insetFromB as M,viewToField as F}from"./geometry.js";import{playerEl as D,clearAimTags as V}from"./render.js";import{ensureHeadMarker as W,rebuildAllMarkers as rt}from"./pass.markers.js";import{headPxFor as st,headTrimPx as nt}from"./pass.headsize.js";import{getArrowSvg as _,ensureGroup as R}from"./svgroot.js";import{logPass as at}from"./logger.js";import{saveUndoState as q}from"./undo-redo.js";import{createArrowObject as it,getArrowStart as lt,getArrowEnd as ct}from"./arrow-anchor.js";function L(t,e=0){const r=getComputedStyle(document.documentElement).getPropertyValue(t);return parseFloat(r)||e}l(L,"getVarPx");const N="http://www.w3.org/2000/svg",Nt=["solid","comic-flat","comic-halftone"];function O(t,e=0){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"){const r=parseFloat(t);return Number.isFinite(r)?r:e}return e}l(O,"safeNumber");function Ht(t){return K(t).overlap??2}l(Ht,"headOverlapFor");async function U(t,e){if(!t)return;const r=t.getTotalLength(),s=tt?.[e]??2,n=Math.max(0,r-s);t.dataset.headBaseLen=String(n);const{attachHead:a}=await import("../assets/arrows/simple-markers.js");try{const i=await a(t,`head-${e}`);i instanceof Promise&&await i,console.log(`\u{1F3AF} Head attached: style=${e}, baseLen=${n.toFixed(1)}px`)}catch(i){try{t.setAttribute&&(t.setAttribute("marker-end",`url(#head-${e})`),t.setAttribute("vector-effect","non-scaling-stroke"),console.log(`\u{1F3AF} Head attached (silent fallback): style=${e}`))}catch{console.debug(`\u26A1 Preview path attachment skipped: ${i.message}`)}}}l(U,"attachPassHead");function Y(t){const e=document.getElementById("arrow-layer");!e||e.querySelector(`#head-${t}`)||import("./assets.arrows.js").then(({preloadArrowHeads:s})=>{s()})}l(Y,"ensurePassMarker");function j(t,e=o.passStyle){if(!t)return;const r=t.querySelector(".pass-shaft");if(!r)return;const s=t.querySelector(".pass-head");s&&s.remove(),Y(e),U(r,e)}l(j,"finalizeHead");function dt(t,e,r,s){const n=r-t,a=s-e,i=Math.hypot(n,a)||1;return{ux:n/i,uy:a/i,d:i}}l(dt,"unit");function C(t){return o.players.find(e=>e.id===t)||null}l(C,"getPlayer");function H(t){return document.querySelector(`.player[data-id="${t}"]`)}l(H,"getPlayerEl");function B(t){return t.x=Math.round(t.x)+.5,t.y=Math.round(t.y)+.5,t}l(B,"snapHalf");function X(){return(document.getElementById("flabHalo")?.offsetWidth||56)/2}l(X,"haloRadiusPx");function z(t){const e=t?.getBoundingClientRect();return Math.max(14,Math.min(e?.width||56,e?.height||56)/2)}l(z,"tokenRadiusPx");function $(t){const e=document.querySelector(`.player[data-id="${t.id}"]`);if(!e)return null;const r=e.getBoundingClientRect(),s=document.getElementById("pitchMount").getBoundingClientRect();return{x:r.left+r.width/2-s.left,y:r.top+r.height/2-s.top}}l($,"getPlayerViewCoords");function ut(t,e,r){let s=null,n=1/0;for(const a of o.players){if(a.id===r)continue;const i=$(a);if(!i)continue;const p=Math.hypot(i.x-t,i.y-e);p<n&&(s=a,n=p)}return{player:s,dist:n}}l(ut,"nearestPlayerView");function pt(t,e){const r=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--pass-origin-gap"))||1.5,s=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--pass-target-gap"))||2,n=G(t),a=G(e),i=X()+r,p=z(e)+s;let h=T(n.x,n.y,a.x,a.y,i),g=M(n.x,n.y,a.x,a.y,p);const{d:S,ux:f,uy:y}=dt(h.x,h.y,g.x,g.y),u=12;if(S<u){const d=(h.x+g.x)/2,w=(h.y+g.y)/2,c=u/2;h={x:d-f*c,y:w-y*c},g={x:d+f*c,y:w+y*c}}return{A:B(h),B:B(g)}}l(pt,"computePassEndpoints");function mt(t,e){const{w:r,h:s}=et(),n=ot(t.x,t.y,e.x,e.y,r,s);return n.visible?{A:B({x:n.ax,y:n.ay}),B:B({x:n.bx,y:n.by})}:null}l(mt,"computeClippedPass");function Gt(t,e=null){const r=o.passStyle,s=r.startsWith("comic")?"pass-comic":"pass-solid";if(t.setAttribute("class",s),e!==null){const i=document.getElementById("arrow-layer")?.querySelector("defs");if(i){const p=W(i,r,e);if(p){t.setAttribute("marker-end",`url(#${p})`);return}}}const n=r==="solid"?"passHead-solid":r==="comic-flat"?"passHead-comic-flat":"passHead-comic-halftone";t.setAttribute("marker-end",`url(#${n})`)}l(Gt,"applyPassStyle");function Q(t,e,r,s,n,a){if(!t)return;console.debug("setArrowPaths",e,r,t?.ownerSVGElement?.id);const i=_(),p=document.getElementById("arrow-group");if(!i||!p){console.warn("setArrowPaths: no arrow SVG root or arrow-group");return}(!t||t.parentNode!==p)&&(t||(t=document.createElementNS(i.namespaceURI,"g")),p.appendChild(t));const h=i.querySelector("defs"),g=W(h,s,n),S=st(n,/comic/.test(s)),f=nt(S),y=r.x-e.x,u=r.y-e.y,d=Math.hypot(y,u)||1,w={x:r.x-y*(f/d),y:r.y-u*(f/d)};Array.from(t.children).forEach(I=>{I.classList.contains("shaft")||t.removeChild(I)});const c=document.createElementNS(N,"path");c.classList.add("pass-shaft"),c.classList.add(a),c.classList.add(`pass-${s}`),c.dataset.passStyle=s,c.setAttribute("vector-effect","non-scaling-stroke"),c.setAttribute("fill","none"),c.setAttribute("d",`M ${e.x} ${e.y} L ${w.x} ${w.y}`);let m="#ffd166";const x=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim();x&&(m=x),b?.color&&(m=b.color),document.documentElement.style.setProperty("--pass-color",m),b&&(b.color=m),c.setAttribute("stroke",m),c.style.stroke=m,c.style.color=m,c.setAttribute("color",m),t.appendChild(c),getComputedStyle(c).stroke,a==="pass-comic"&&c.removeAttribute("stroke-dasharray");let A=0;const E=l(()=>{A++;const I=c.getAttribute("stroke"),P=getComputedStyle(c).stroke,J=c.style.stroke;console.log(`\u{1F50D} SHAFT DEBUG (check ${A}):`),console.log(`  - Intended color: ${m}`),console.log(`  - SVG stroke attribute: ${I}`),console.log(`  - Computed stroke style: ${P}`),console.log(`  - Inline style.stroke: ${J}`),A<5&&setTimeout(E,200),A===1&&console.log("  - Element:",c)},"monitorChanges");setTimeout(E,100);const k=new MutationObserver(I=>{I.forEach(P=>{P.type==="attributes"&&(P.attributeName==="stroke"||P.attributeName==="style")&&(console.log("\u{1F6A8} SHAFT MODIFIED by external code!"),console.log(`  - Attribute changed: ${P.attributeName}`),console.log(`  - New value: ${c.getAttribute(P.attributeName)}`),console.log(`  - Current computed stroke: ${getComputedStyle(c).stroke}`))})});k.observe(c,{attributes:!0,attributeFilter:["stroke","style"]}),setTimeout(()=>k.disconnect(),5e3),console.log(`\u2705 Shaft created with direct color: ${m} (CSS: ${x}, PASS: ${b?.color}), style: ${a}`),Y(s),U(c,s),c.style.strokeDashoffset="",c.style.strokeLinecap="butt"}l(Q,"setArrowPaths");function ft(t){const{id:e,fromId:r,to:s,curved:n=!1,control:a=null}=t;if(!C(r))return null;const p=document.querySelector(`.player[data-id="${r}"]`);if(!p)return null;const h=lt(r),g=ct(t);if(!h||!g)return null;const S=document.createElement("div");S.style.cssText=`position:absolute;left:${g.x}px;top:${g.y}px;width:56px;height:56px;pointer-events:none;`,document.querySelector(".flab-field").appendChild(S);try{const{A:f,B:y}=pt(p,S);let u;if(n&&a){const d=O(a.x,(f.x+y.x)/2),w=O(a.y,(f.y+y.y)/2);u=`M ${f.x} ${f.y} Q ${d} ${w} ${y.x} ${y.y}`}else{const d=mt(f,y);d?u=`M ${d.A.x} ${d.A.y} L ${d.B.x} ${d.B.y}`:u=""}if(u.match(/NaN|Infinity|-Infinity/))return console.warn("Rejected path with invalid coordinates:",u),null;{const d=Math.hypot(y.x-f.x,y.y-f.y),w=o.passStyle,c=w.startsWith("comic")?"pass-comic":"pass-solid",m=document.createElementNS(N,"g");m.setAttribute("data-arrow-id",String(e)),m.classList.add("svg-pass"),Q(m,f,y,w,d,c);const x=document.createElementNS(N,"path");return x.setAttribute("d",u),x.classList.add("flab-arrow-hitbox"),m.appendChild(x),m}}finally{S.remove()}}l(ft,"createPass");function Tt(t){for(o.passArm={drawing:!0,curved:!1,latest:$(t)},o.activePlayer=t,o.aim.candidateId=null,o.aim.lockedId=null,o.aim.showAt=0,V(),o.previewG=R("pass-preview");o.previewG.firstChild;)o.previewG.removeChild(o.previewG.firstChild)}l(Tt,"beginPassPreview");function yt(t){return t.startsWith("comic")?"pass-comic":"pass-solid"}l(yt,"shaftClassFor");function Dt(){if(!o.passArm?.drawing)return;const t=o.activePlayer;if(!t)return;const e=o.passArm.latest,r=L("--pass-target-gap",2),s=$(t);let n=e;if(o.aim.lockedId){const E=C(o.aim.lockedId),k=$(E);s&&k&&(n=M(s.x,s.y,k.x,k.y,28+r))}gt(t.id,n,o.passArm.curved,o.passArm.control);const a=F(s),i=F(n),p=o.passStyle,h=o.passWidth,g=b.color||"#ffd166",S=!!o.passArm?.curved,f=t.id,y=t.number??t.id,u=o.aim?.lockedId??null,d=u?C(u):null,w=d?.id??null,c=d?.number??d?.id??null,m=n.x-s.x,x=n.y-s.y,A=Math.hypot(m,x);for(at({fromId:f,toId:w,fromNum:y,toNum:c,style:p,width:h,color:g,curved:S,lengthPx:A,startField:a,endField:i}),o.passArm=null,o.aim.candidateId=o.aim.lockedId=null,V();o.previewG?.firstChild;)o.previewG.removeChild(o.previewG.firstChild)}l(Dt,"commitPass");function Wt(t){if(!o.passArm?.drawing)return;const e=o.activePlayer;if(!e||!t||typeof t.x!="number"||typeof t.y!="number")return;console.debug("[pass] move",t.x|0,t.y|0),o.passArm.latest=t;let r=null;if(v.enabled){const{player:u,dist:d}=ut(t.x,t.y,e.id);u&&d<=v.radius&&(r=u)}const s=performance.now();if(r)if(o.aim.lockedId){const u=C(o.aim.lockedId),d=$(u);d&&Math.hypot(d.x-t.x,d.y-t.y)>v.radius+v.hysteresis&&(o.aim.lockedId=null,o.aim.candidateId=r.id,o.aim.showAt=s)}else o.aim.candidateId!==r.id?(o.aim.candidateId=r.id,o.aim.showAt=s):s-o.aim.showAt>=v.delay&&(o.aim.lockedId=r.id);else o.aim.candidateId=null,o.aim.lockedId=null;V(),o.aim.candidateId&&!o.aim.lockedId&&D(o.aim.candidateId)?.setAttribute("data-aim","pre"),o.aim.lockedId&&D(o.aim.lockedId)?.setAttribute("data-aim","lock");const n=(document.getElementById("flabHalo")?.offsetWidth||0)/2,a=L("--pass-origin-gap",1.5),i=$(e);if(!i)return;const p=T(i.x,i.y,t.x,t.y,n+a);let h=t.x,g=t.y;const S=L("--pass-target-gap",2),f=28;if(o.aim.lockedId){const u=C(o.aim.lockedId),d=$(u);if(d){const w=d.x-i.x,c=d.y-i.y,m=w**2+c**2;if(m>0){const x=t.x-i.x,A=t.y-i.y;if((x*w+A*c)/m>1.05)o.aim.lockedId=null,o.aim.candidateId=null;else{const k=M(i.x,i.y,d.x,d.y,f+S);h=k.x,g=k.y}}}}const y=Math.hypot(h-p.x,g-p.y);Q(o.previewG,p,{x:h,y:g},o.passStyle,y,yt(o.passStyle)),j(o.previewG,o.passStyle)}l(Wt,"updatePassPreview");function gt(t,e,r=!1,s=null){if(!e)return;const a=(o.aim?.lockedId??null)||null,i=C(t),p=H(t);let h=null,g=null;if(i&&p){const u=p.getBoundingClientRect(),d=document.querySelector(".flab-field").getBoundingClientRect(),w={x:u.left+u.width/2-d.left,y:u.top+u.height/2-d.top};h=F(w);let c=e;if(a){const m=H(a);if(m){const x=m.getBoundingClientRect(),A=document.querySelector(".flab-field").getBoundingClientRect();c={x:x.left+x.width/2-A.left,y:x.top+x.height/2-A.top}}}g=F(c)}const S={toId:a,startInsetPx:L("--pass-origin-gap",1.5)+X(),endInsetPx:L("--pass-target-gap",2)+(a?z(H(a)):0),headInsetPx:16,startField:h,endField:g,createdAt:performance.now()},f=o.arrowCounter++,y=it(t,a,e,r,s);y.id=f,y.meta=S,o.arrows.push(y),o.lastPassId=f,V(),import("./render.js").then(({renderArrows:u})=>{u()}),setTimeout(()=>St(f),100),q(`Add pass from player ${t}`)}l(gt,"commitArrow");async function ht(){if(!_())return;const e=document.getElementById("arrow-group");if(!e){console.warn("renderArrows: #arrow-group not found");return}if(e.querySelectorAll(".svg-pass").forEach(n=>n.remove()),o.arrows&&o.arrows.length>0){const{migrateArrow:n}=await import("./arrow-anchor.js");o.arrows=o.arrows.map(a=>{const i=n(a);return(!i.to||i.to.playerId===void 0)&&console.log(`\u26A1 Migrated arrow #${a.id} to new anchor format`),i})}const s=o.arrows.map(n=>ft(n));Promise.all(s).then(n=>{n.forEach(a=>{a&&(e.appendChild(a),j(a,o.passStyle))}),wt()}),document.getElementById("arrow-layer")?.classList.toggle("is-interactive",o.mode==="erase")}l(ht,"renderArrows");function wt(){let t="#ffd166";const e=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim();e&&(t=e),b?.color&&(t=b.color);const r=document.querySelectorAll(".pass-shaft");console.log(`\u{1F527} Force updating ${r.length} shaft colors to: ${t} (CSS: ${e}, PASS: ${b?.color})`),r.forEach((s,n)=>{console.log(`\u{1F527} Updating shaft ${n+1}:`),console.log(`  - Before: stroke="${s.getAttribute("stroke")}", style.stroke="${s.style.stroke}"`),s.setAttribute("stroke",t),s.style.stroke=t,s.style.color=t,s.setAttribute("color",t),console.log(`  - After: stroke="${s.getAttribute("stroke")}", style.stroke="${s.style.stroke}"`),setTimeout(()=>{const a=getComputedStyle(s).stroke;console.log(`  - Computed after 100ms: ${a}`)},100)})}l(wt,"forceUpdateAllShaftColors");function _t(){const t=o.arrows||[];t.length>0&&(t.pop(),console.log("Cleared last pass"),q("Delete last pass"))}l(_t,"clearLastPass");function Ot(){o.arrows=[],console.log("Cleared all passes"),q("Clear all passes")}l(Ot,"clearAllPasses");function Ut(){const t=document.getElementById("arrow-layer");if(!t){console.error("Cannot initialize pass tool: #arrow-layer not found");return}if(!o.previewGroup)o.previewGroup=R("pass-preview");else{for(;o.previewGroup.firstChild;)o.previewGroup.removeChild(o.previewGroup.firstChild);o.previewGroup=R("pass-preview")}t.addEventListener("pointerdown",e=>{if(o.mode!=="erase")return;const r=e.target.closest(".svg-pass");if(!r)return;const s=r.getAttribute("data-arrow-id");s&&(e.preventDefault(),e.stopPropagation(),o.arrows=o.arrows.filter(n=>n.id!==parseInt(s)),ht())})}l(Ut,"initPassTool");function xt(t){return document.querySelector(`#arrow-group [data-arrow-id="${t}"] .pass-shaft`)||document.querySelector(`#arrow-group [data-arrow-id="${t}"] path`)||document.querySelector(`#arrow-layer [data-arrow-id="${t}"] path`)}l(xt,"getShaftPathForPass");function Yt(t){const e=t.meta||{};return{startInsetPx:e.startInsetPx??18,endInsetPx:(e.endInsetPx??18)+(e.headInsetPx??16)}}l(Yt,"getPassInsets");function St(t){document.querySelectorAll("#arrow-group [data-arrow-id].is-selected").forEach(e=>e.classList.remove("is-selected")),document.querySelectorAll(`#arrow-group [data-arrow-id="${t}"]`).forEach(e=>e.classList.add("is-selected"))}l(St,"highlightPass");function jt(t){return xt(t)}l(jt,"getPassPathNode");function Xt(t){const e=o.arrows.find(r=>r.id.toString()===t.toString());return e?{id:e.id.toString(),fromId:e.fromId,toId:e.toId||null,curved:e.curved||!1,style:o.passStyle,width:o.passWidth,color:b.color||"#ffd166"}:null}l(Xt,"getPassMeta");function zt(){const t=o.arrows;return t.length>0?t[t.length-1].id.toString():null}l(zt,"getLastPassId");function Qt(){return o.arrows.map(t=>t.id.toString())}l(Qt,"getAllPassIds");function Jt(){document.querySelectorAll("#arrow-group [data-arrow-id].is-selected").forEach(e=>e.classList.remove("is-selected"))}l(Jt,"clearPassHighlight");function Zt(){const t=[...document.querySelectorAll("#arrow-layer path.pass-shaft")].map(e=>{const r=e.getTotalLength(),s=Number(e.dataset.headBaseLen??r),a=e.parentNode.querySelector(".pass-head")?.getAttribute("transform")||"",i=parseFloat(getComputedStyle(e).strokeWidth);return{L:+r.toFixed(1),headBase:+s.toFixed(1),gap:+(r-s).toFixed(2),sw:i,transform:a.slice(0,80)}});console.table(t)}l(Zt,"logHeadDiagnostics");function Kt(){const t=b?.color||getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#ffd166";document.documentElement.style.setProperty("--pass-color",t),import("../assets/arrows/simple-markers.js").then(({updateMarkerColors:r})=>r?.(t)).catch(r=>console.warn("updateMarkerColors import failed",r));const e=document.querySelectorAll(".pass-shaft");e.forEach(r=>{r.setAttribute("stroke",t),r.style.stroke=t,r.style.color=t,r.setAttribute("color",t),getComputedStyle(r).stroke}),console.log(`\u{1F3A8} Forced refresh of ${e.length} arrow shafts with color: ${t}`)}l(Kt,"forceArrowRefresh");window.__mod_pass=!0;export{U as attachPassHead,Tt as beginPassPreview,Ot as clearAllPasses,_t as clearLastPass,Jt as clearPassHighlight,gt as commitArrow,Dt as commitPass,mt as computeClippedPass,pt as computePassEndpoints,Kt as forceArrowRefresh,Qt as getAllPassIds,zt as getLastPassId,Yt as getPassInsets,Xt as getPassMeta,jt as getPassPathNode,xt as getShaftPathForPass,St as highlightPass,Ut as initPassTool,Zt as logHeadDiagnostics,rt as rebuildAllMarkers,ht as renderArrows,Wt as updatePassPreview};
//# sourceMappingURL=pass.js.map
