var Z=Object.defineProperty;var i=(t,e)=>Z(t,"name",{value:e,configurable:!0});import{FLAB as o,AIM as v,headSpec as K,PASS as S}from"./state.js";import{HEAD_OVERLAP as tt}from"./assets.arrows.js";import{centerInField as G,fieldSize as et,clipSegmentToRect as ot,insetFromA as T,insetFromB as R,viewToField as F}from"./geometry.js";import{playerEl as D,clearAimTags as V}from"./render.js";import{ensureHeadMarker as W,rebuildAllMarkers as rt}from"./pass.markers.js";import{headPxFor as st,headTrimPx as nt}from"./pass.headsize.js";import{getArrowSvg as _,ensureGroup as M}from"./svgroot.js";import{logPass as at}from"./logger.js";import{saveUndoState as q}from"./undo-redo.js";function L(t,e=0){const r=getComputedStyle(document.documentElement).getPropertyValue(t);return parseFloat(r)||e}i(L,"getVarPx");const N="http://www.w3.org/2000/svg",Vt=["solid","comic-flat","comic-halftone"];function U(t,e=0){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"){const r=parseFloat(t);return Number.isFinite(r)?r:e}return e}i(U,"safeNumber");function Bt(t){return K(t).overlap??2}i(Bt,"headOverlapFor");async function Y(t,e){if(!t)return;const r=t.getTotalLength(),s=tt?.[e]??2,n=Math.max(0,r-s);t.dataset.headBaseLen=String(n);const{attachHead:l}=await import("../assets/arrows/simple-markers.js");try{const a=await l(t,`head-${e}`);a instanceof Promise&&await a,console.log(`\u{1F3AF} Head attached: style=${e}, baseLen=${n.toFixed(1)}px`)}catch(a){try{t.setAttribute&&(t.setAttribute("marker-end",`url(#head-${e})`),t.setAttribute("vector-effect","non-scaling-stroke"),console.log(`\u{1F3AF} Head attached (silent fallback): style=${e}`))}catch{console.debug(`\u26A1 Preview path attachment skipped: ${a.message}`)}}}i(Y,"attachPassHead");function O(t){const e=document.getElementById("arrow-layer");!e||e.querySelector(`#head-${t}`)||import("./assets.arrows.js").then(({preloadArrowHeads:s})=>{s()})}i(O,"ensurePassMarker");function X(t,e=o.passStyle){if(!t)return;const r=t.querySelector(".pass-shaft");if(!r)return;const s=t.querySelector(".pass-head");s&&s.remove(),O(e),Y(r,e)}i(X,"finalizeHead");function it(t,e,r,s){const n=r-t,l=s-e,a=Math.hypot(n,l)||1;return{ux:n/a,uy:l/a,d:a}}i(it,"unit");function $(t){return o.players.find(e=>e.id===t)||null}i($,"getPlayer");function H(t){return document.querySelector(`.player[data-id="${t}"]`)}i(H,"getPlayerEl");function B(t){return t.x=Math.round(t.x)+.5,t.y=Math.round(t.y)+.5,t}i(B,"snapHalf");function j(){return(document.getElementById("flabHalo")?.offsetWidth||56)/2}i(j,"haloRadiusPx");function z(t){const e=t?.getBoundingClientRect();return Math.max(14,Math.min(e?.width||56,e?.height||56)/2)}i(z,"tokenRadiusPx");function C(t){const e=document.querySelector(`.player[data-id="${t.id}"]`);if(!e)return null;const r=e.getBoundingClientRect(),s=document.getElementById("pitchMount").getBoundingClientRect();return{x:r.left+r.width/2-s.left,y:r.top+r.height/2-s.top}}i(C,"getPlayerViewCoords");function lt(t,e,r){let s=null,n=1/0;for(const l of o.players){if(l.id===r)continue;const a=C(l);if(!a)continue;const m=Math.hypot(a.x-t,a.y-e);m<n&&(s=l,n=m)}return{player:s,dist:n}}i(lt,"nearestPlayerView");function ct(t,e){const r=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--pass-origin-gap"))||1.5,s=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--pass-target-gap"))||2,n=G(t),l=G(e),a=j()+r,m=z(e)+s;let p=T(n.x,n.y,l.x,l.y,a),f=R(n.x,n.y,l.x,l.y,m);const{d:w,ux:y,uy:h}=it(p.x,p.y,f.x,f.y),u=12;if(w<u){const c=(p.x+f.x)/2,g=(p.y+f.y)/2,d=u/2;p={x:c-y*d,y:g-h*d},f={x:c+y*d,y:g+h*d}}return{A:B(p),B:B(f)}}i(ct,"computePassEndpoints");function dt(t,e){const{w:r,h:s}=et(),n=ot(t.x,t.y,e.x,e.y,r,s);return n.visible?{A:B({x:n.ax,y:n.ay}),B:B({x:n.bx,y:n.by})}:null}i(dt,"computeClippedPass");function Rt(t,e=null){const r=o.passStyle,s=r.startsWith("comic")?"pass-comic":"pass-solid";if(t.setAttribute("class",s),e!==null){const a=document.getElementById("arrow-layer")?.querySelector("defs");if(a){const m=W(a,r,e);if(m){t.setAttribute("marker-end",`url(#${m})`);return}}}const n=r==="solid"?"passHead-solid":r==="comic-flat"?"passHead-comic-flat":"passHead-comic-halftone";t.setAttribute("marker-end",`url(#${n})`)}i(Rt,"applyPassStyle");function Q(t,e,r,s,n,l){if(!t)return;console.debug("setArrowPaths",e,r,t?.ownerSVGElement?.id);const a=_(),m=document.getElementById("arrow-group");if(!a||!m){console.warn("setArrowPaths: no arrow SVG root or arrow-group");return}(!t||t.parentNode!==m)&&(t||(t=document.createElementNS(a.namespaceURI,"g")),m.appendChild(t));const p=a.querySelector("defs"),f=W(p,s,n),w=st(n,/comic/.test(s)),y=nt(w),h=r.x-e.x,u=r.y-e.y,c=Math.hypot(h,u)||1,g={x:r.x-h*(y/c),y:r.y-u*(y/c)};Array.from(t.children).forEach(I=>{I.classList.contains("shaft")||t.removeChild(I)});const d=document.createElementNS(N,"path");d.classList.add("pass-shaft"),d.classList.add(l),d.classList.add(`pass-${s}`),d.dataset.passStyle=s,d.setAttribute("vector-effect","non-scaling-stroke"),d.setAttribute("fill","none"),d.setAttribute("d",`M ${e.x} ${e.y} L ${g.x} ${g.y}`);let x="#ffd166";const k=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim();k&&(x=k),S?.color&&(x=S.color),document.documentElement.style.setProperty("--pass-color",x),S&&(S.color=x),d.setAttribute("stroke",x),d.style.stroke=x,d.style.color=x,d.setAttribute("color",x),t.appendChild(d),getComputedStyle(d).stroke,l==="pass-comic"&&d.removeAttribute("stroke-dasharray");let b=0;const E=i(()=>{b++;const I=d.getAttribute("stroke"),P=getComputedStyle(d).stroke,J=d.style.stroke;console.log(`\u{1F50D} SHAFT DEBUG (check ${b}):`),console.log(`  - Intended color: ${x}`),console.log(`  - SVG stroke attribute: ${I}`),console.log(`  - Computed stroke style: ${P}`),console.log(`  - Inline style.stroke: ${J}`),b<5&&setTimeout(E,200),b===1&&console.log("  - Element:",d)},"monitorChanges");setTimeout(E,100);const A=new MutationObserver(I=>{I.forEach(P=>{P.type==="attributes"&&(P.attributeName==="stroke"||P.attributeName==="style")&&(console.log("\u{1F6A8} SHAFT MODIFIED by external code!"),console.log(`  - Attribute changed: ${P.attributeName}`),console.log(`  - New value: ${d.getAttribute(P.attributeName)}`),console.log(`  - Current computed stroke: ${getComputedStyle(d).stroke}`))})});A.observe(d,{attributes:!0,attributeFilter:["stroke","style"]}),setTimeout(()=>A.disconnect(),5e3),console.log(`\u2705 Shaft created with direct color: ${x} (CSS: ${k}, PASS: ${S?.color}), style: ${l}`),O(s),Y(d,s),d.style.strokeDashoffset="",d.style.strokeLinecap="butt"}i(Q,"setArrowPaths");function ut({id:t,fromId:e,to:r,curved:s=!1,control:n=null}){if(!$(e))return null;const a=document.querySelector(`.player[data-id="${e}"]`);if(!a)return null;const m=document.createElement("div");m.style.cssText=`position:absolute;left:${r.x}px;top:${r.y}px;width:56px;height:56px;pointer-events:none;`,document.querySelector(".flab-field").appendChild(m);try{const{A:p,B:f}=ct(a,m);let w;if(s&&n){const y=U(n.x,(p.x+f.x)/2),h=U(n.y,(p.y+f.y)/2);w=`M ${p.x} ${p.y} Q ${y} ${h} ${f.x} ${f.y}`}else{const y=dt(p,f);y?w=`M ${y.A.x} ${y.A.y} L ${y.B.x} ${y.B.y}`:w=""}if(w.match(/NaN|Infinity|-Infinity/))return console.warn("Rejected path with invalid coordinates:",w),null;{const y=Math.hypot(f.x-p.x,f.y-p.y),h=o.passStyle,u=h.startsWith("comic")?"pass-comic":"pass-solid",c=document.createElementNS(N,"g");c.setAttribute("data-arrow-id",String(t)),c.classList.add("svg-pass"),Q(c,p,f,h,y,u);const g=document.createElementNS(N,"path");return g.setAttribute("d",w),g.classList.add("flab-arrow-hitbox"),c.appendChild(g),c}}finally{m.remove()}}i(ut,"createPass");function Mt(t){for(o.passArm={drawing:!0,curved:!1,latest:C(t)},o.activePlayer=t,o.aim.candidateId=null,o.aim.lockedId=null,o.aim.showAt=0,V(),o.previewG=M("pass-preview");o.previewG.firstChild;)o.previewG.removeChild(o.previewG.firstChild)}i(Mt,"beginPassPreview");function pt(t){return t.startsWith("comic")?"pass-comic":"pass-solid"}i(pt,"shaftClassFor");function qt(){if(!o.passArm?.drawing)return;const t=o.activePlayer;if(!t)return;const e=o.passArm.latest,r=L("--pass-target-gap",2),s=C(t);let n=e;if(o.aim.lockedId){const E=$(o.aim.lockedId),A=C(E);s&&A&&(n=R(s.x,s.y,A.x,A.y,28+r))}mt(t.id,n,o.passArm.curved,o.passArm.control);const l=F(s),a=F(n),m=o.passStyle,p=o.passWidth,f=S.color||"#ffd166",w=!!o.passArm?.curved,y=t.id,h=t.number??t.id,u=o.aim?.lockedId??null,c=u?$(u):null,g=c?.id??null,d=c?.number??c?.id??null,x=n.x-s.x,k=n.y-s.y,b=Math.hypot(x,k);for(at({fromId:y,toId:g,fromNum:h,toNum:d,style:m,width:p,color:f,curved:w,lengthPx:b,startField:l,endField:a}),o.passArm=null,o.aim.candidateId=o.aim.lockedId=null,V();o.previewG?.firstChild;)o.previewG.removeChild(o.previewG.firstChild)}i(qt,"commitPass");function Nt(t){if(!o.passArm?.drawing)return;const e=o.activePlayer;if(!e||!t||typeof t.x!="number"||typeof t.y!="number")return;console.debug("[pass] move",t.x|0,t.y|0),o.passArm.latest=t;let r=null;if(v.enabled){const{player:u,dist:c}=lt(t.x,t.y,e.id);u&&c<=v.radius&&(r=u)}const s=performance.now();if(r)if(o.aim.lockedId){const u=$(o.aim.lockedId),c=C(u);c&&Math.hypot(c.x-t.x,c.y-t.y)>v.radius+v.hysteresis&&(o.aim.lockedId=null,o.aim.candidateId=r.id,o.aim.showAt=s)}else o.aim.candidateId!==r.id?(o.aim.candidateId=r.id,o.aim.showAt=s):s-o.aim.showAt>=v.delay&&(o.aim.lockedId=r.id);else o.aim.candidateId=null,o.aim.lockedId=null;V(),o.aim.candidateId&&!o.aim.lockedId&&D(o.aim.candidateId)?.setAttribute("data-aim","pre"),o.aim.lockedId&&D(o.aim.lockedId)?.setAttribute("data-aim","lock");const n=(document.getElementById("flabHalo")?.offsetWidth||0)/2,l=L("--pass-origin-gap",1.5),a=C(e);if(!a)return;const m=T(a.x,a.y,t.x,t.y,n+l);let p=t.x,f=t.y;const w=L("--pass-target-gap",2),y=28;if(o.aim.lockedId){const u=$(o.aim.lockedId),c=C(u);if(c){const g=c.x-a.x,d=c.y-a.y,x=g**2+d**2;if(x>0){const k=t.x-a.x,b=t.y-a.y;if((k*g+b*d)/x>1.05)o.aim.lockedId=null,o.aim.candidateId=null;else{const A=R(a.x,a.y,c.x,c.y,y+w);p=A.x,f=A.y}}}}const h=Math.hypot(p-m.x,f-m.y);Q(o.previewG,m,{x:p,y:f},o.passStyle,h,pt(o.passStyle)),X(o.previewG,o.passStyle)}i(Nt,"updatePassPreview");function mt(t,e,r=!1,s=null){if(!e)return;const n=o.aim?.lockedId??null;let l=e;const a=n?$(n):null;if(a){const u=H(a.id);if(u){const c=u.getBoundingClientRect(),g=document.querySelector(".flab-field").getBoundingClientRect();l={x:c.left+c.width/2-g.left,y:c.top+c.height/2-g.top}}}const m=$(t),p=H(t);let f=null,w=null;if(m&&p){const u=p.getBoundingClientRect(),c=document.querySelector(".flab-field").getBoundingClientRect(),g={x:u.left+u.width/2-c.left,y:u.top+u.height/2-c.top};f=F(g),w=F(l)}const y={toId:n,startInsetPx:L("--pass-origin-gap",1.5)+j(),endInsetPx:L("--pass-target-gap",2)+(n?z(H(n)):0),headInsetPx:16,startField:f,endField:w,createdAt:performance.now()},h=o.arrowCounter++;o.arrows.push({id:h,fromId:t,to:{x:l.x,y:l.y},curved:r,control:s?{x:s.x,y:s.y}:null,meta:y}),o.lastPassId=h,V(),import("./render.js").then(({renderArrows:u})=>{u()}),setTimeout(()=>ht(h),100),q(`Add pass from player ${t}`)}i(mt,"commitArrow");function ft(){if(!_())return;const e=document.getElementById("arrow-group");if(!e){console.warn("renderArrows: #arrow-group not found");return}e.querySelectorAll(".svg-pass").forEach(n=>n.remove());const s=o.arrows.map(n=>ut(n));Promise.all(s).then(n=>{n.forEach(l=>{l&&(e.appendChild(l),X(l,o.passStyle))}),yt()}),document.getElementById("arrow-layer")?.classList.toggle("is-interactive",o.mode==="erase")}i(ft,"renderArrows");function yt(){let t="#ffd166";const e=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim();e&&(t=e),S?.color&&(t=S.color);const r=document.querySelectorAll(".pass-shaft");console.log(`\u{1F527} Force updating ${r.length} shaft colors to: ${t} (CSS: ${e}, PASS: ${S?.color})`),r.forEach((s,n)=>{console.log(`\u{1F527} Updating shaft ${n+1}:`),console.log(`  - Before: stroke="${s.getAttribute("stroke")}", style.stroke="${s.style.stroke}"`),s.setAttribute("stroke",t),s.style.stroke=t,s.style.color=t,s.setAttribute("color",t),console.log(`  - After: stroke="${s.getAttribute("stroke")}", style.stroke="${s.style.stroke}"`),setTimeout(()=>{const l=getComputedStyle(s).stroke;console.log(`  - Computed after 100ms: ${l}`)},100)})}i(yt,"forceUpdateAllShaftColors");function Ht(){const t=o.arrows||[];t.length>0&&(t.pop(),console.log("Cleared last pass"),q("Delete last pass"))}i(Ht,"clearLastPass");function Gt(){o.arrows=[],console.log("Cleared all passes"),q("Clear all passes")}i(Gt,"clearAllPasses");function Tt(){const t=document.getElementById("arrow-layer");if(!t){console.error("Cannot initialize pass tool: #arrow-layer not found");return}if(!o.previewGroup)o.previewGroup=M("pass-preview");else{for(;o.previewGroup.firstChild;)o.previewGroup.removeChild(o.previewGroup.firstChild);o.previewGroup=M("pass-preview")}t.addEventListener("pointerdown",e=>{if(o.mode!=="erase")return;const r=e.target.closest(".svg-pass");if(!r)return;const s=r.getAttribute("data-arrow-id");s&&(e.preventDefault(),e.stopPropagation(),o.arrows=o.arrows.filter(n=>n.id!==parseInt(s)),ft())})}i(Tt,"initPassTool");function gt(t){return document.querySelector(`#arrow-group [data-arrow-id="${t}"] .pass-shaft`)||document.querySelector(`#arrow-group [data-arrow-id="${t}"] path`)||document.querySelector(`#arrow-layer [data-arrow-id="${t}"] path`)}i(gt,"getShaftPathForPass");function Dt(t){const e=t.meta||{};return{startInsetPx:e.startInsetPx??18,endInsetPx:(e.endInsetPx??18)+(e.headInsetPx??16)}}i(Dt,"getPassInsets");function ht(t){document.querySelectorAll("#arrow-group [data-arrow-id].is-selected").forEach(e=>e.classList.remove("is-selected")),document.querySelectorAll(`#arrow-group [data-arrow-id="${t}"]`).forEach(e=>e.classList.add("is-selected"))}i(ht,"highlightPass");function Wt(t){return gt(t)}i(Wt,"getPassPathNode");function _t(t){const e=o.arrows.find(r=>r.id.toString()===t.toString());return e?{id:e.id.toString(),fromId:e.fromId,toId:e.toId||null,curved:e.curved||!1,style:o.passStyle,width:o.passWidth,color:S.color||"#ffd166"}:null}i(_t,"getPassMeta");function Ut(){const t=o.arrows;return t.length>0?t[t.length-1].id.toString():null}i(Ut,"getLastPassId");function Yt(){return o.arrows.map(t=>t.id.toString())}i(Yt,"getAllPassIds");function Ot(){document.querySelectorAll("#arrow-group [data-arrow-id].is-selected").forEach(e=>e.classList.remove("is-selected"))}i(Ot,"clearPassHighlight");function Xt(){const t=[...document.querySelectorAll("#arrow-layer path.pass-shaft")].map(e=>{const r=e.getTotalLength(),s=Number(e.dataset.headBaseLen??r),l=e.parentNode.querySelector(".pass-head")?.getAttribute("transform")||"",a=parseFloat(getComputedStyle(e).strokeWidth);return{L:+r.toFixed(1),headBase:+s.toFixed(1),gap:+(r-s).toFixed(2),sw:a,transform:l.slice(0,80)}});console.table(t)}i(Xt,"logHeadDiagnostics");function jt(){const t=S?.color||getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#ffd166";document.documentElement.style.setProperty("--pass-color",t),import("../assets/arrows/simple-markers.js").then(({updateMarkerColors:r})=>r?.(t)).catch(r=>console.warn("updateMarkerColors import failed",r));const e=document.querySelectorAll(".pass-shaft");e.forEach(r=>{r.setAttribute("stroke",t),r.style.stroke=t,r.style.color=t,r.setAttribute("color",t),getComputedStyle(r).stroke}),console.log(`\u{1F3A8} Forced refresh of ${e.length} arrow shafts with color: ${t}`)}i(jt,"forceArrowRefresh");window.__mod_pass=!0;export{Y as attachPassHead,Mt as beginPassPreview,Gt as clearAllPasses,Ht as clearLastPass,Ot as clearPassHighlight,mt as commitArrow,qt as commitPass,dt as computeClippedPass,ct as computePassEndpoints,jt as forceArrowRefresh,Yt as getAllPassIds,Ut as getLastPassId,Dt as getPassInsets,_t as getPassMeta,Wt as getPassPathNode,gt as getShaftPathForPass,ht as highlightPass,Tt as initPassTool,Xt as logHeadDiagnostics,rt as rebuildAllMarkers,ft as renderArrows,Nt as updatePassPreview};
//# sourceMappingURL=pass.js.map
