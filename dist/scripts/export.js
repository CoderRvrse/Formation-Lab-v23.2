var q=Object.defineProperty;var c=(e,t)=>q(e,"name",{value:t,configurable:!0});import{FLAB as p,PITCH_LAND as J,PITCH_PORT as U,PASS as M}from"./state.js";import{normToView as W,getVar as P,insetFromA as Y,insetFromB as N}from"./geometry.js";import{ARROW_ASSETS as O}from"./assets.arrows.js";import{headPxFor as _,headTrimPx as X}from"./pass.headsize.js";import{showSpinner as B,hideSpinner as L}from"./loading-spinner.js";import{handleError as Z}from"./error-handler.js";import{showSuccessToast as K,showErrorToast as Q}from"./ui-toast.js";const R=56,v={landscape:{left:24,right:24,top:24,bottom:24},portrait:{left:24,right:24,top:28,bottom:28}},m=new Image;m.src="assets/jersey.svg";function z(e){return p.players.find(t=>t.id===e)||null}c(z,"getPlayer");function ue(e){import("./ui.js").then(({showToast:t})=>{t(e)}).catch(()=>{console.log(e)})}c(ue,"showToast");function k(e,t){console.log(`Telemetry: ${e}`,t)}c(k,"logTelemetry");function ee(e){const t=p.passStyle;e.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#f0c419",t==="dashed"?(e.setLineDash([14,10]),e.lineWidth=4):t.startsWith("comic")?(e.setLineDash([2,8]),e.lineWidth=5):(e.setLineDash([]),e.lineWidth=4)}c(ee,"applyCanvasPassStyle");function he(e,t,o){return Math.max(t,Math.min(o,e))}c(he,"clamp");function te(e,t,o){return e.replace(/fill\s*=\s*["'][^"']*["']/gi,`fill="${t}"`).replace(/stroke\s*=\s*["'][^"']*["']/gi,`stroke="${o}"`)}c(te,"recolorSVG");async function ge(e,t,o){const a=O.get(e);if(!a)return null;const s=te(a.svgText,t,o),n=new Image;return n.src="data:image/svg+xml;utf8,"+encodeURIComponent(s),await n.decode().catch(()=>{}),n}c(ge,"getColoredImage");function oe(e,t,o,a){const s=Math.hypot(o.x-t.x,o.y-t.y),n=/comic/.test(a),r=_(s,n),d=Math.atan2(o.y-t.y,o.x-t.x),i=getComputedStyle(document.documentElement).getPropertyValue("--pass-color")?.trim()||M.color,l=getComputedStyle(document.documentElement).getPropertyValue("--pass-outline")?.trim()||M.outline;e.save(),e.translate(o.x,o.y),e.rotate(d),e.beginPath(),e.moveTo(0,0),e.lineTo(-r,r/2),e.lineTo(-r,-r/2),e.closePath(),e.fillStyle=i,e.fill(),e.lineWidth=P("--pass-head-outline",1.4),e.strokeStyle=l,e.stroke(),e.restore()}c(oe,"drawHeadCanvas");async function re(){if(m.complete){if(m.naturalWidth>0)return;throw new Error("jersey_unavailable")}if(typeof m.decode=="function")try{if(await m.decode(),m.naturalWidth>0)return}catch(e){console.warn("jersey_decode_failed",e)}if(await new Promise((e,t)=>{m.addEventListener("load",e,{once:!0}),m.addEventListener("error",()=>t(new Error("Failed to load jersey.svg")),{once:!0})}),m.naturalWidth===0)throw new Error("jersey_unavailable")}c(re,"ensureJerseyReady");function ne(e,t,o,a,s){const n=a/2,r=a/R||1;m.complete&&m.naturalWidth>0?e.drawImage(m,t-n,o-n,a,a):(e.save(),e.fillStyle="#0b2b72",e.beginPath(),e.arc(t,o,n,0,Math.PI*2),e.fill(),e.restore());const d=14*r,i=4*r,l=t+n-d-i,y=o+n-d-i;e.save(),e.fillStyle="#ffd166",e.strokeStyle="rgba(0, 0, 0, 0.12)",e.lineWidth=Math.max(1,2*r),e.beginPath(),e.arc(l,y,d,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#0b2b66",e.font=`${Math.max(12,14*r)}px "Segoe UI", Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(String(s),l,y),e.restore()}c(ne,"drawJersey");function ae(e,t,o){e.save();const a=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#f0c419";e.strokeStyle=a,e.fillStyle=a,ee(e),e.lineCap="round";const s=Math.min(t/800,o/600);p.arrows.forEach(n=>{const r=z(n.fromId);if(!r)return;const i=p.orientation==="portrait"?v.portrait:v.landscape,l={x:i.left*(t/720),y:i.top*(o/460),w:t-(i.left+i.right)*(t/720),h:o-(i.top+i.bottom)*(o/460)},{vx:y,vy:u}=W(r.nx,r.ny),g={x:l.x+y*l.w,y:l.y+u*l.h},E=t/(document.querySelector(".flab-field")?.clientWidth||800),b=o/(document.querySelector(".flab-field")?.clientHeight||600),S={x:n.to.x*E,y:n.to.y*b},V=28*s,A=P("--pass-origin-gap",1.5)*s,F=P("--pass-target-gap",2)*s,f=Y(g.x,g.y,S.x,S.y,V+A),D=28*s,h=N(g.x,g.y,S.x,S.y,D+F),C=Math.hypot(h.x-f.x,h.y-f.y),j=/comic/.test(p.passStyle),H=_(C,j),T=X(H),$=h.x-f.x,G=h.y-f.y,x=C||1,w={x:h.x-$*(T/x),y:h.y-G*(T/x)};if(n.curved&&n.control){const I={x:n.control.x*E,y:n.control.y*b};e.beginPath(),e.moveTo(f.x,f.y),e.quadraticCurveTo(I.x,I.y,w.x,w.y)}else e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(w.x,w.y);e.stroke(),oe(e,f,h,p.passStyle)}),e.restore()}c(ae,"drawArrows");function se(e,t,o){const a=Math.min(t/720,o/460);p.players.forEach(s=>{const r=p.orientation==="portrait"?v.portrait:v.landscape,d={x:r.left*(t/720),y:r.top*(o/460),w:t-(r.left+r.right)*(t/720),h:o-(r.top+r.bottom)*(o/460)},{vx:i,vy:l}=W(s.nx,s.ny),y=d.x+i*d.w,u=d.y+l*d.h;ne(e,y,u,R*a,s.id)})}c(se,"drawPlayers");async function Se(){const e=B("Exporting formation...");try{const t=document.querySelector(".flab-field"),o=window.devicePixelRatio||1,a=Math.max(1,t?.clientWidth||800),s=Math.max(1,t?.clientHeight||600),n=document.createElement("canvas");n.width=Math.round(a*o),n.height=Math.round(s*o);const r=n.getContext("2d");if(!r)throw new Error("Canvas context unavailable for export");r.scale(o,o);try{await re()}catch(u){console.warn("Jersey image load failed (non-critical):",u)}const d=p.orientation==="portrait"?U:J,i=new Image;i.src=d;try{await i.decode()}catch{throw new Error("Failed to load pitch image. Please try again.")}r.drawImage(i,0,0,a,s),ae(r,a,s),se(r,a,s),r.save(),r.font='12px "Segoe UI", Arial, sans-serif',r.fillStyle="rgba(255, 255, 255, 0.4)",r.textAlign="right",r.fillText(`Formation Lab ${p.version}`,a-10,s-10),r.restore();let l;try{l=n.toDataURL("image/png")}catch{throw new Error("Failed to create image data. Canvas may be too large.")}const y=document.createElement("a");y.href=l,y.download=`formation-${Date.now()}.png`,y.click(),L(e),K("Formation exported successfully!"),k("export_png",{width:n.width,height:n.height,arrows:p.arrows.length,dpr:o,success:!0})}catch(t){L(e),Z(t,"export",!0),Q("Export failed. Please try again."),k("export_png",{error:t.message,success:!1})}}c(Se,"exportPNG"),window.__mod_export=!0;export{Se as exportPNG};
//# sourceMappingURL=export.js.map
