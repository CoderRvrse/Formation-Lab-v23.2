var $=Object.defineProperty;var d=(e,t)=>$(e,"name",{value:t,configurable:!0});import{FLAB as p,PITCH_LAND as q,PITCH_PORT as U,PASS as _}from"./state.js";import{normToView as W,getVar as w,insetFromA as J,insetFromB as Y}from"./geometry.js";import{ARROW_ASSETS as N}from"./assets.arrows.js";import{headPxFor as k,headTrimPx as O}from"./pass.headsize.js";const L=56,v={landscape:{left:24,right:24,top:24,bottom:24},portrait:{left:24,right:24,top:28,bottom:28}},m=new Image;m.src="assets/jersey.svg";function X(e){return p.players.find(t=>t.id===e)||null}d(X,"getPlayer");function b(e){import("./ui.js").then(({showToast:t})=>{t(e)}).catch(()=>{console.log(e)})}d(b,"showToast");function B(e,t){console.log(`Telemetry: ${e}`,t)}d(B,"logTelemetry");function Z(e){const t=p.passStyle;e.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#f0c419",t==="dashed"?(e.setLineDash([14,10]),e.lineWidth=4):t.startsWith("comic")?(e.setLineDash([2,8]),e.lineWidth=5):(e.setLineDash([]),e.lineWidth=4)}d(Z,"applyCanvasPassStyle");function ie(e,t,o){return Math.max(t,Math.min(o,e))}d(ie,"clamp");function K(e,t,o){return e.replace(/fill\s*=\s*["'][^"']*["']/gi,`fill="${t}"`).replace(/stroke\s*=\s*["'][^"']*["']/gi,`stroke="${o}"`)}d(K,"recolorSVG");async function ce(e,t,o){const s=N.get(e);if(!s)return null;const a=K(s.svgText,t,o),n=new Image;return n.src="data:image/svg+xml;utf8,"+encodeURIComponent(a),await n.decode().catch(()=>{}),n}d(ce,"getColoredImage");function Q(e,t,o,s){const a=Math.hypot(o.x-t.x,o.y-t.y),n=/comic/.test(s),r=k(a,n),l=Math.atan2(o.y-t.y,o.x-t.x),i=getComputedStyle(document.documentElement).getPropertyValue("--pass-color")?.trim()||_.color,c=getComputedStyle(document.documentElement).getPropertyValue("--pass-outline")?.trim()||_.outline;e.save(),e.translate(o.x,o.y),e.rotate(l),e.beginPath(),e.moveTo(0,0),e.lineTo(-r,r/2),e.lineTo(-r,-r/2),e.closePath(),e.fillStyle=i,e.fill(),e.lineWidth=w("--pass-head-outline",1.4),e.strokeStyle=c,e.stroke(),e.restore()}d(Q,"drawHeadCanvas");async function z(){if(m.complete){if(m.naturalWidth>0)return;throw new Error("jersey_unavailable")}if(typeof m.decode=="function")try{if(await m.decode(),m.naturalWidth>0)return}catch(e){console.warn("jersey_decode_failed",e)}if(await new Promise((e,t)=>{m.addEventListener("load",e,{once:!0}),m.addEventListener("error",()=>t(new Error("Failed to load jersey.svg")),{once:!0})}),m.naturalWidth===0)throw new Error("jersey_unavailable")}d(z,"ensureJerseyReady");function ee(e,t,o,s,a){const n=s/2,r=s/L||1;m.complete&&m.naturalWidth>0?e.drawImage(m,t-n,o-n,s,s):(e.save(),e.fillStyle="#0b2b72",e.beginPath(),e.arc(t,o,n,0,Math.PI*2),e.fill(),e.restore());const l=14*r,i=4*r,c=t+n-l-i,y=o+n-l-i;e.save(),e.fillStyle="#ffd166",e.strokeStyle="rgba(0, 0, 0, 0.12)",e.lineWidth=Math.max(1,2*r),e.beginPath(),e.arc(c,y,l,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#0b2b66",e.font=`${Math.max(12,14*r)}px "Segoe UI", Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(String(a),c,y),e.restore()}d(ee,"drawJersey");function te(e,t,o){e.save();const s=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#f0c419";e.strokeStyle=s,e.fillStyle=s,Z(e),e.lineCap="round";const a=Math.min(t/800,o/600);p.arrows.forEach(n=>{const r=X(n.fromId);if(!r)return;const i=p.orientation==="portrait"?v.portrait:v.landscape,c={x:i.left*(t/720),y:i.top*(o/460),w:t-(i.left+i.right)*(t/720),h:o-(i.top+i.bottom)*(o/460)},{vx:y,vy:P}=W(r.nx,r.ny),h={x:c.x+y*c.w,y:c.y+P*c.h},E=t/(document.querySelector(".flab-field")?.clientWidth||800),C=o/(document.querySelector(".flab-field")?.clientHeight||600),g={x:n.to.x*E,y:n.to.y*C},R=28*a,V=w("--pass-origin-gap",1.5)*a,A=w("--pass-target-gap",2)*a,f=J(h.x,h.y,g.x,g.y,R+V),j=28*a,u=Y(h.x,h.y,g.x,g.y,j+A),T=Math.hypot(u.x-f.x,u.y-f.y),F=/comic/.test(p.passStyle),D=k(T,F),x=O(D),H=u.x-f.x,G=u.y-f.y,I=T||1,S={x:u.x-H*(x/I),y:u.y-G*(x/I)};if(n.curved&&n.control){const M={x:n.control.x*E,y:n.control.y*C};e.beginPath(),e.moveTo(f.x,f.y),e.quadraticCurveTo(M.x,M.y,S.x,S.y)}else e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(S.x,S.y);e.stroke(),Q(e,f,u,p.passStyle)}),e.restore()}d(te,"drawArrows");function oe(e,t,o){const s=Math.min(t/720,o/460);p.players.forEach(a=>{const r=p.orientation==="portrait"?v.portrait:v.landscape,l={x:r.left*(t/720),y:r.top*(o/460),w:t-(r.left+r.right)*(t/720),h:o-(r.top+r.bottom)*(o/460)},{vx:i,vy:c}=W(a.nx,a.ny),y=l.x+i*l.w,P=l.y+c*l.h;ee(e,y,P,L*s,a.id)})}d(oe,"drawPlayers");async function de(){b("Exporting formation...");const e=document.querySelector(".flab-field"),t=window.devicePixelRatio||1,o=Math.max(1,e?.clientWidth||800),s=Math.max(1,e?.clientHeight||600),a=document.createElement("canvas");a.width=Math.round(o*t),a.height=Math.round(s*t);const n=a.getContext("2d");if(!n){console.error("Canvas context unavailable for export."),b("Export failed - canvas unavailable");return}n.scale(t,t);try{await z()}catch(y){console.warn("jersey_load_fallback",y)}const r=p.orientation==="portrait"?U:q,l=new Image;l.src=r,await l.decode(),n.drawImage(l,0,0,o,s),te(n,o,s),oe(n,o,s),n.save(),n.font='12px "Segoe UI", Arial, sans-serif',n.fillStyle="rgba(255, 255, 255, 0.4)",n.textAlign="right",n.fillText(`Formation Lab ${p.version}`,o-10,s-10),n.restore();const i=a.toDataURL("image/png"),c=document.createElement("a");c.href=i,c.download="formation.png",c.click(),b("Formation exported successfully!"),B("export_png",{width:a.width,height:a.height,arrows:p.arrows.length,dpr:t})}d(de,"exportPNG"),window.__mod_export=!0;export{de as exportPNG};
//# sourceMappingURL=export.js.map
