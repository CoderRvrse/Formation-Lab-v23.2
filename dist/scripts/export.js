var q=Object.defineProperty;var m=(e,o)=>q(e,"name",{value:o,configurable:!0});import{FLAB as p,PITCH_LAND as J,PITCH_PORT as U,PASS as C}from"./state.js";import{normToView as I,getVar as v,insetFromA as B,insetFromB as Y}from"./geometry.js";import{ARROW_ASSETS as N}from"./assets.arrows.js";import{headPxFor as z,headTrimPx as O}from"./pass.headsize.js";import{showSpinner as X,hideSpinner as M}from"./loading-spinner.js";import{handleError as Z}from"./error-handler.js";import{showSuccessToast as K,showErrorToast as Q}from"./ui-toast.js";const _=56,T={landscape:{left:24,right:24,top:24,bottom:24},portrait:{left:24,right:24,top:28,bottom:28}},y=new Image;y.src="assets/jersey.svg";function x(e){return p.players.find(o=>o.id===e)||null}m(x,"getPlayer");function he(e){import("./ui.js").then(({showToast:o})=>{o(e)}).catch(()=>{console.log(e)})}m(he,"showToast");function L(e,o){console.log(`Telemetry: ${e}`,o)}m(L,"logTelemetry");function ee(e,o,t){const c=["rgba(0, 77, 152, 0.6)","rgba(168, 19, 62, 0.6)","rgba(237, 187, 0, 0.6)","rgba(255, 237, 2, 0.6)","rgba(219, 0, 48, 0.6)"][0];e.save(),[{x:0,y:0,label:"top-left"},{x:o-40,y:0,label:"top-right"},{x:o-40,y:t-40,label:"bottom-right"},{x:0,y:t-40,label:"bottom-left"}].forEach((r,d)=>{e.strokeStyle=c,e.lineWidth=2,e.beginPath(),d===0?(e.moveTo(r.x,r.y+8),e.lineTo(r.x,r.y),e.lineTo(r.x+8,r.y)):d===1?(e.moveTo(r.x+40-8,r.y),e.lineTo(r.x+40,r.y),e.lineTo(r.x+40,r.y+8)):d===2?(e.moveTo(r.x+40,r.y+40-8),e.lineTo(r.x+40,r.y+40),e.lineTo(r.x+40-8,r.y+40)):d===3&&(e.moveTo(r.x+8,r.y+40),e.lineTo(r.x,r.y+40),e.lineTo(r.x,r.y+40-8)),e.stroke()}),e.strokeStyle=c,e.lineWidth=2,e.shadowColor="rgba(0, 77, 152, 0.4)",e.shadowBlur=8,e.beginPath(),e.moveTo(0,0),e.lineTo(o,0),e.stroke(),e.beginPath(),e.moveTo(o,0),e.lineTo(o,t),e.stroke(),e.beginPath(),e.moveTo(o,t),e.lineTo(0,t),e.stroke(),e.beginPath(),e.moveTo(0,t),e.lineTo(0,0),e.stroke(),e.restore()}m(ee,"drawBorderDecorations");function oe(e){const o=p.passStyle;e.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#f0c419",o==="dashed"?(e.setLineDash([14,10]),e.lineWidth=4):o.startsWith("comic")?(e.setLineDash([2,8]),e.lineWidth=5):(e.setLineDash([]),e.lineWidth=4)}m(oe,"applyCanvasPassStyle");function ge(e,o,t){return Math.max(o,Math.min(t,e))}m(ge,"clamp");function te(e,o,t){return e.replace(/fill\s*=\s*["'][^"']*["']/gi,`fill="${o}"`).replace(/stroke\s*=\s*["'][^"']*["']/gi,`stroke="${t}"`)}m(te,"recolorSVG");async function Se(e,o,t){const i=N.get(e);if(!i)return null;const s=te(i.svgText,o,t),a=new Image;return a.src="data:image/svg+xml;utf8,"+encodeURIComponent(s),await a.decode().catch(()=>{}),a}m(Se,"getColoredImage");function re(e,o,t,i){const s=Math.hypot(t.x-o.x,t.y-o.y),a=/comic/.test(i),n=z(s,a),c=Math.atan2(t.y-o.y,t.x-o.x),l=getComputedStyle(document.documentElement).getPropertyValue("--pass-color")?.trim()||C.color,r=getComputedStyle(document.documentElement).getPropertyValue("--pass-outline")?.trim()||C.outline;e.save(),e.translate(t.x,t.y),e.rotate(c),e.beginPath(),e.moveTo(0,0),e.lineTo(-n,n/2),e.lineTo(-n,-n/2),e.closePath(),e.fillStyle=l,e.fill(),e.lineWidth=v("--pass-head-outline",1.4),e.strokeStyle=r,e.stroke(),e.restore()}m(re,"drawHeadCanvas");async function ne(){if(y.complete){if(y.naturalWidth>0)return;throw new Error("jersey_unavailable")}if(typeof y.decode=="function")try{if(await y.decode(),y.naturalWidth>0)return}catch(e){console.warn("jersey_decode_failed",e)}if(await new Promise((e,o)=>{y.addEventListener("load",e,{once:!0}),y.addEventListener("error",()=>o(new Error("Failed to load jersey.svg")),{once:!0})}),y.naturalWidth===0)throw new Error("jersey_unavailable")}m(ne,"ensureJerseyReady");function ae(e,o,t,i,s){const a=i/2,n=i/_||1;y.complete&&y.naturalWidth>0?e.drawImage(y,o-a,t-a,i,i):(e.save(),e.fillStyle="#0b2b72",e.beginPath(),e.arc(o,t,a,0,Math.PI*2),e.fill(),e.restore());const c=14*n,l=4*n,r=o+a-c-l,d=t+a-c-l;e.save(),e.fillStyle="#ffd166",e.strokeStyle="rgba(0, 0, 0, 0.12)",e.lineWidth=Math.max(1,2*n),e.beginPath(),e.arc(r,d,c,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#0b2b66",e.font=`${Math.max(12,14*n)}px "Segoe UI", Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(String(s),r,d),e.restore()}m(ae,"drawJersey");function ie(e,o,t){e.save();const i=getComputedStyle(document.documentElement).getPropertyValue("--pass-color").trim()||"#f0c419";e.strokeStyle=i,e.fillStyle=i,oe(e),e.lineCap="round";const s=Math.min(o/800,t/600);p.arrows.forEach(a=>{const n=x(a.fromId);if(!n)return;const l=p.orientation==="portrait"?T.portrait:T.landscape,r={x:l.left*(o/720),y:l.top*(t/460),w:o-(l.left+l.right)*(o/720),h:t-(l.top+l.bottom)*(t/460)},{vx:d,vy:u}=I(n.nx,n.ny),g={x:r.x+d*r.w,y:r.y+u*r.h},P=o/(document.querySelector(".flab-field")?.clientWidth||800),w=t/(document.querySelector(".flab-field")?.clientHeight||600),S={x:a.to.x*P,y:a.to.y*w},V=28*s,A=v("--pass-origin-gap",1.5)*s,F=v("--pass-target-gap",2)*s,f=B(g.x,g.y,S.x,S.y,V+A),D=28*s,h=Y(g.x,g.y,S.x,S.y,D+F),E=Math.hypot(h.x-f.x,h.y-f.y),j=/comic/.test(p.passStyle),H=z(E,j),R=O(H),$=h.x-f.x,G=h.y-f.y,W=E||1,b={x:h.x-$*(R/W),y:h.y-G*(R/W)};if(a.curved&&a.control){const k={x:a.control.x*P,y:a.control.y*w};e.beginPath(),e.moveTo(f.x,f.y),e.quadraticCurveTo(k.x,k.y,b.x,b.y)}else e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(b.x,b.y);e.stroke(),re(e,f,h,p.passStyle)}),e.restore()}m(ie,"drawArrows");function se(e,o,t){const i=Math.min(o/720,t/460);p.players.forEach(s=>{const n=p.orientation==="portrait"?T.portrait:T.landscape,c={x:n.left*(o/720),y:n.top*(t/460),w:o-(n.left+n.right)*(o/720),h:t-(n.top+n.bottom)*(t/460)},{vx:l,vy:r}=I(s.nx,s.ny),d=c.x+l*c.w,u=c.y+r*c.h;ae(e,d,u,_*i,s.id)})}m(se,"drawPlayers");async function be(){const e=X("Exporting formation...");try{const o=document.querySelector(".flab-field"),t=window.devicePixelRatio||1,i=Math.max(1,o?.clientWidth||800),s=Math.max(1,o?.clientHeight||600),a=document.createElement("canvas");a.width=Math.round(i*t),a.height=Math.round(s*t);const n=a.getContext("2d");if(!n)throw new Error("Canvas context unavailable for export");n.scale(t,t);try{await ne()}catch(u){console.warn("Jersey image load failed (non-critical):",u)}const c=p.orientation==="portrait"?U:J,l=new Image;l.src=c;try{await l.decode()}catch{throw new Error("Failed to load pitch image. Please try again.")}n.drawImage(l,0,0,i,s),ie(n,i,s),se(n,i,s),ee(n,i,s),n.save(),n.font='12px "Segoe UI", Arial, sans-serif',n.fillStyle="rgba(255, 255, 255, 0.4)",n.textAlign="right",n.fillText(`Formation Lab ${p.version}`,i-10,s-10),n.restore();let r;try{r=a.toDataURL("image/png")}catch{throw new Error("Failed to create image data. Canvas may be too large.")}const d=document.createElement("a");d.href=r,d.download=`formation-${Date.now()}.png`,d.click(),M(e),K("Formation exported successfully!"),L("export_png",{width:a.width,height:a.height,arrows:p.arrows.length,dpr:t,success:!0})}catch(o){M(e),Z(o,"export",!0),Q("Export failed. Please try again."),L("export_png",{error:o.message,success:!1})}}m(be,"exportPNG"),window.__mod_export=!0;export{be as exportPNG};
//# sourceMappingURL=export.js.map
