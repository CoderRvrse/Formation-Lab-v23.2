var X=Object.defineProperty;var s=(e,t)=>X(e,"name",{value:t,configurable:!0});import{FLAB as r}from"./state.js";import{n2p_view as v,p2n_view as Y,clampPx as _,toView as w}from"./geometry.js";import{beginPassPreview as S,updatePassPreview as B,commitPass as $}from"./pass.js";import{saveUndoState as k}from"./undo-redo.js";const F=6,K={GK:"goalkeeper",DF:"defender",MF:"midfielder",FW:"forward"};let p=new Map,o=null,a=null;function b(e,t){const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}}s(b,"getLocalPoint");function P(e){return r.players.find(t=>t.id===e)||null}s(P,"getPlayer");function j(e){const t=e.target.closest(".player[data-id]");return t?{id:parseInt(t.dataset.id)}:null}s(j,"hitPlayer");function q(e){if(!a){a={id:e.pointerId,move:s(t=>{if(!r.passArm?.drawing)return;const n=w(t.clientX,t.clientY);B(n)},"move"),up:s(t=>{if(!(!a||t.pointerId!==a.id)){window.removeEventListener("pointermove",a.move,!0),window.removeEventListener("pointerup",a.up,!0),window.removeEventListener("pointercancel",a.up,!0);try{document.getElementById("pitchMount")?.releasePointerCapture(a.id)}catch{}if(a=null,r.passArm?.drawing){const n=w(t.clientX,t.clientY);r.passArm.latest=n,$()}}},"up")},window.addEventListener("pointermove",a.move,!0),window.addEventListener("pointerup",a.up,!0),window.addEventListener("pointercancel",a.up,!0);try{document.getElementById("pitchMount")?.setPointerCapture(e.pointerId)}catch{}}}s(q,"startPointerStream");function A(e){const t=r.selectedId;e===r.selectedId?r.selectedId=null:r.selectedId=e??null,t!==r.selectedId&&import("./render.js").then(({updateHalo:n})=>{n()})}s(A,"selectPlayer");function z(e){const t=r.arrows.length;r.arrows=r.arrows.filter(n=>n.fromId!==e),t!==r.arrows.length&&import("./render.js").then(({renderArrows:n})=>{n()})}s(z,"removeArrowsByPlayer");function H(e){const t=document.createElement("div");return t.className="flab-player player",t.dataset.id=String(e.id),t.dataset.role=e.role,t.tabIndex=0,t.setAttribute("role","button"),t.setAttribute("aria-label",`Player ${e.id}, ${K[e.role]}`),t.innerHTML=`
    <img class="jersey" src="assets/jersey.svg" alt="" draggable="false" />
    <span class="num">${e.id}</span>
  `,t.addEventListener("pointerdown",O),t.addEventListener("pointermove",n=>R(n,e.id)),t.addEventListener("pointerup",n=>I(n,e.id)),t.addEventListener("pointercancel",n=>I(n,e.id)),t.addEventListener("keydown",n=>T(n,e.id)),t}s(H,"createPlayerElement");function O(e){e.stopPropagation(),e.preventDefault();const t=j(e);if(!t)return;if(r.mode==="pass"){if(r.passArm?.drawing)return;console.log("[pass] begin from player",t.id),r.activePlayer=P(t.id),S(r.activePlayer),q(e);return}const n=p.get(t.id),i=P(t.id);if(!n||!i)return;if(r.mode==="erase"){z(t.id);return}o.classList.remove("can-hover"),o.classList.add("lab-pressing","is-engaged");const u=b(e,o),{x:m,y:f}=v(i.nx,i.ny),d={x:m,y:f};A(t.id),e.preventDefault(),n.setPointerCapture(e.pointerId),n.classList.add("is-grabbing"),n.style.willChange="transform",r.drag={pointerId:e.pointerId,playerId:t.id,origin:u,grabDX:d.x-u.x,grabDY:d.y-u.y,started:!1}}s(O,"onPointerDown");function R(e,t){if(r.passArm&&r.passArm.fromId===t&&r.passArm.pointerId===e.pointerId){const l=w(e.clientX,e.clientY);if(r.passArm.latest=l,r.passArm.curved=e.altKey,r.passArm.curved){const c=l.x-r.passArm.origin.x,L=l.y-r.passArm.origin.y,E=r.passArm.origin.x+c*.5,C=r.passArm.origin.y+L*.5,D=-L*.3,M=c*.3;r.passArm.control={x:E+D,y:C+M}}else r.passArm.control=null;import("./pass.js").then(({updatePassPreview:c})=>{c(l)});return}if(!r.drag||r.drag.playerId!==t||r.drag.pointerId!==e.pointerId)return;const n=b(e,o),i=P(t);if(!i)return;const u=n.x-r.drag.origin.x,m=n.y-r.drag.origin.y,f=Math.hypot(u,m);if(!r.drag.started&&f<F)return;e.preventDefault(),r.drag.started||(r.drag.started=!0,o.classList.add("is-engaged"));let d=n.x+r.drag.grabDX,g=n.y+r.drag.grabDY;({x:d,y:g}=_(d,g));const x=Y(d,g);i.nx=Math.min(1,Math.max(0,x.nx)),i.ny=Math.min(1,Math.max(0,x.ny));const h=v(i.nx,i.ny),y=p.get(t);y&&(y.style.left=`${h.x}px`,y.style.top=`${h.y}px`),import("./render.js").then(({updateHalo:l,renderArrows:c})=>{l(),c()})}s(R,"onPlayerPointerMove");function I(e,t){const n=p.get(t);if(r.passArm&&r.passArm.fromId===t&&r.passArm.pointerId===e.pointerId){e.preventDefault(),n?.classList.remove("is-grabbing"),n&&(n.style.willChange="auto"),n?.hasPointerCapture?.(e.pointerId)&&n.releasePointerCapture(e.pointerId),r.passArm?.drawing?(console.log("[pass] commit"),import("./pass.js").then(({commitPass:i})=>{i()})):r.passArm=null,import("./pass.js").then(({updatePassPreview:i})=>{i(null,null)}),o.classList.remove("lab-pressing","is-engaged"),o.classList.add("can-hover");return}!r.drag||r.drag.playerId!==t||r.drag.pointerId!==e.pointerId||(e.preventDefault(),n?.classList.remove("is-grabbing"),n&&(n.style.willChange="auto"),r.drag.started&&(n?.hasPointerCapture?.(e.pointerId)&&n.releasePointerCapture(e.pointerId),k(`Move player ${t}`)),o.classList.remove("lab-pressing","is-engaged"),o.classList.add("can-hover"),r.drag=null)}s(I,"onPlayerPointerUp");function T(e,t){(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),A(t))}s(T,"onPlayerKeyDown");function J(){if(o=document.querySelector(".flab-field"),!o){console.error("Cannot initialize drag: .flab-field not found");return}const e=document.querySelector(".flab-players");if(!e){console.error("Cannot initialize drag: .flab-players not found");return}e.innerHTML="",p.clear(),r.players.forEach(t=>{const n=H(t);e.appendChild(n),p.set(t.id,n)}),import("./render.js").then(({renderPlayers:t,renderArrows:n,updateHalo:i})=>{t(),n(),i()}),o.classList.add("can-hover")}s(J,"initDrag");window.__mod_drag=!0;export{J as initDrag,O as onPointerDown,p as playerEls};
//# sourceMappingURL=drag.js.map
