{
  "version": 3,
  "sources": ["../../scripts/render.js"],
  "sourcesContent": ["// Render module for Formation Lab\r\nimport { FLAB } from './state.js';\r\nimport { n2p_view, p2n_view, clampPx } from './geometry.js';\r\nimport { playerEls } from './drag.js';\r\n\r\n// SVG namespace constants\r\nconst SVG_NS = 'http://www.w3.org/2000/svg';\r\n\r\n// Layer management for ball visibility\r\nexport function ensureLayer(id) {\r\n  const svg = document.getElementById('arrow-layer');\r\n  if (!svg) return null;\r\n\r\n  let g = document.getElementById(id);\r\n  if (!g) {\r\n    g = document.createElementNS(SVG_NS, 'g');\r\n    g.id = id;\r\n    g.setAttribute('pointer-events', 'none');\r\n    svg.appendChild(g);\r\n  }\r\n  return g;\r\n}\r\n\r\nexport function ensureLayerOrder() {\r\n  const svg = document.getElementById('arrow-layer');\r\n  if (!svg) {\r\n    console.warn('ensureLayerOrder: #arrow-layer not found');\r\n    return;\r\n  }\r\n\r\n  // Get the existing arrow-group that has the transforms and clipping\r\n  const arrowGroup = document.getElementById('arrow-group');\r\n  if (!arrowGroup) {\r\n    console.warn('ensureLayerOrder: #arrow-group not found');\r\n    return;\r\n  }\r\n\r\n  // Create ball layer INSIDE the arrow-group (same coordinate space)\r\n  let ballLayer = document.getElementById('ball-layer');\r\n  if (!ballLayer) {\r\n    ballLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n    ballLayer.id = 'ball-layer';\r\n    ballLayer.setAttribute('pointer-events', 'none');\r\n  }\r\n\r\n  // Ensure ball layer is the LAST child of arrow-group (paints on top)\r\n  if (ballLayer.parentNode !== arrowGroup) {\r\n    arrowGroup.appendChild(ballLayer);\r\n  }\r\n\r\n  // Create debug layer as sibling to arrow-group (outside clipping)\r\n  let debugLayer = document.getElementById('arrow-debug-layer');\r\n  if (!debugLayer) {\r\n    debugLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n    debugLayer.id = 'arrow-debug-layer';\r\n    debugLayer.setAttribute('pointer-events', 'none');\r\n    svg.appendChild(debugLayer);\r\n  }\r\n\r\n  console.log('\uD83C\uDFA8 Layer order ensured: ball-layer inside arrow-group (same transforms)');\r\n}\r\n\r\n// Utility functions for aim-assist\r\nexport function playerEl(id) {\r\n  return document.querySelector(`.player[data-id=\"${id}\"]`);\r\n}\r\n\r\nexport function clearAimTags() {\r\n  document.querySelectorAll('.player[data-aim]').forEach(n => n.removeAttribute('data-aim'));\r\n}\r\n\r\n// Keep players inside playable area by clamping their canonical coordinates\r\nfunction clampPlayerCanonical(pl) {\r\n  // project to current view \u2192 clamp px \u2192 convert back to canonical norm\r\n  const p = n2p_view(pl.nx, pl.ny);\r\n  const pc = clampPx(p.x, p.y);\r\n  if (pc.x !== p.x || pc.y !== p.y) {\r\n    const n = p2n_view(pc.x, pc.y);\r\n    pl.nx = Math.min(1, Math.max(0, n.nx));\r\n    pl.ny = Math.min(1, Math.max(0, n.ny));\r\n  }\r\n}\r\n\r\n// Place player element using normalized coordinates\r\nexport function placePlayerEl(el, player) {\r\n  const { x, y } = n2p_view(player.nx, player.ny);\r\n  el.style.left = `${x}px`;\r\n  el.style.top = `${y}px`;\r\n}\r\n\r\n// Re-layout all players after resize/orientation change\r\nexport function relayoutAllPlayers() {\r\n  // First clamp all players to ensure they stay inside playable area\r\n  (FLAB.players || []).forEach(clampPlayerCanonical);\r\n\r\n  // Then position the DOM elements\r\n  for (const p of FLAB.players) {\r\n    const el = document.querySelector(`.flab-player[data-id=\"${p.id}\"]`);\r\n    if (el) placePlayerEl(el, p);\r\n  }\r\n}\r\n\r\n// Ensure halo exists and is properly configured\r\nexport function ensureHalo() {\r\n  let halo = document.getElementById('flabHalo');\r\n  if (!halo) {\r\n    console.warn('Creating fallback halo element');\r\n    halo = document.createElement('div');\r\n    halo.id = 'flabHalo';\r\n    halo.className = 'flab-halo';\r\n    halo.style.cssText = 'position:absolute;width:56px;height:56px;pointer-events:none;opacity:0;';\r\n    halo.setAttribute('aria-hidden', 'true');\r\n\r\n    const field = document.getElementById('formationField');\r\n    if (field) field.appendChild(halo);\r\n  }\r\n\r\n  // Ensure pointer events are disabled\r\n  halo.style.pointerEvents = 'none';\r\n  return halo;\r\n}\r\n\r\nexport function updateHalo() {\r\n  const halo = ensureHalo();\r\n  if (!FLAB.selectedId) {\r\n    halo.classList.remove(\"is-visible\");\r\n    return;\r\n  }\r\n  const player = FLAB.players.find(p => p.id === FLAB.selectedId);\r\n  if (!player) {\r\n    halo.classList.remove(\"is-visible\");\r\n    return;\r\n  }\r\n  const { x, y } = n2p_view(player.nx, player.ny);\r\n  halo.style.left = `${x}px`;\r\n  halo.style.top = `${y}px`;\r\n  halo.classList.add(\"is-visible\");\r\n}\r\n\r\nexport function renderPlayers() {\r\n  FLAB.players.forEach(player => {\r\n    const el = playerEls.get(player.id);\r\n    if (!el) return;\r\n    placePlayerEl(el, player);\r\n  });\r\n}\r\n\r\nexport function renderArrows() {\r\n  // Import and call renderArrows from pass module\r\n  import('./pass.js').then(({ renderArrows }) => {\r\n    renderArrows();\r\n  });\r\n}\r\n\r\n// Resize handling\r\nexport function handleResize() {\r\n  // Re-measure and re-layout everything\r\n  relayoutAllPlayers();\r\n  updateHalo();\r\n  renderArrows();\r\n}\r\n\r\nwindow.__mod_render = true;"],
  "mappings": "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",
  "names": ["FLAB", "n2p_view", "p2n_view", "clampPx", "playerEls", "SVG_NS", "ensureLayer", "id", "svg", "g", "__name", "ensureLayerOrder", "arrowGroup", "ballLayer", "debugLayer", "playerEl", "clearAimTags", "n", "clampPlayerCanonical", "pl", "p", "pc", "placePlayerEl", "el", "player", "x", "y", "relayoutAllPlayers", "ensureHalo", "halo", "field", "updateHalo", "renderPlayers", "renderArrows", "handleResize"]
}
